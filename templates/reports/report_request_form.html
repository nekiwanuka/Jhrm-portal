{% extends 'base.html' %}

{% block page_title %}Request Report{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Enter details</span>
  </div>
  <div class="card-body">
    <form method="post" class="purpose-form-shell">
      {% csrf_token %}

      <div class="form-steps" aria-label="Report request steps">
        <div class="form-step is-active">
          <span class="form-step-index">1</span>
          <span class="form-step-label">Report Scope</span>
        </div>
        <div class="form-step is-active">
          <span class="form-step-index">2</span>
          <span class="form-step-label">Date Range</span>
        </div>
        <div class="form-step is-active">
          <span class="form-step-index">3</span>
          <span class="form-step-label">Target Employees</span>
        </div>
      </div>

      <p class="purpose-form-subtitle mb-3">Choose report scope, date range, and who should submit the report.</p>

      <div class="form-card-grid">
        <p>
          {{ form.report_type.label_tag }}
          {{ form.report_type }}
          {% if form.report_type.errors %}<div class="text-danger small">{{ form.report_type.errors }}</div>{% endif %}
        </p>

        <p>
          {{ form.start_date.label_tag }}
          {{ form.start_date }}
          {% if form.start_date.errors %}<div class="text-danger small">{{ form.start_date.errors }}</div>{% endif %}
        </p>

        <p>
          {{ form.end_date.label_tag }}
          {{ form.end_date }}
          {% if form.end_date.errors %}<div class="text-danger small">{{ form.end_date.errors }}</div>{% endif %}
        </p>

        <p>
          {{ form.department_name.label_tag }}
          {{ form.department_name }}
          {% if form.department_name.errors %}<div class="text-danger small">{{ form.department_name.errors }}</div>{% endif %}
          <small class="text-muted">Optional: used as a label/filter for the request.</small>
        </p>

        <div class="form-check mb-2">
          {{ form.request_all_employees }}
          {{ form.request_all_employees.label_tag }}
          {% if form.request_all_employees.help_text %}<div class="text-muted small">{{ form.request_all_employees.help_text }}</div>{% endif %}
        </div>

        <p>
          <label class="form-label" for="employee-search">Search employees</label>
          <input id="employee-search" type="text" class="form-control" placeholder="Type to filter employees...">
        </p>

        <p>
          {{ form.requested_employees.label_tag }}
          {{ form.requested_employees }}
          {% if form.requested_employees.errors %}<div class="text-danger small">{{ form.requested_employees.errors }}</div>{% endif %}
        </p>

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}
      </div>

      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary" type="submit">Save</button>
        <a class="btn btn-outline-secondary" href="javascript:history.back()">Cancel</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
  const searchInput = document.getElementById('employee-search');
  const select = document.getElementById('id_requested_employees');
  const allCheckbox = document.getElementById('id_request_all_employees');

  if (!select) return;

  const allOptions = Array.from(select.options).map(o => ({ value: o.value, text: o.text }));

  function renderOptions(filterText) {
    const q = (filterText || '').trim().toLowerCase();
    const selectedValues = new Set(Array.from(select.selectedOptions).map(o => o.value));

    select.innerHTML = '';

	const selected = allOptions.filter(o => selectedValues.has(o.value));
	const filtered = allOptions
		.filter(o => o.text.toLowerCase().includes(q))
		.filter(o => !selectedValues.has(o.value));
	const finalList = selected.concat(filtered);

	finalList.forEach(o => {
		const opt = document.createElement('option');
		opt.value = o.value;
		opt.textContent = o.text;
		if (selectedValues.has(o.value)) opt.selected = true;
		select.appendChild(opt);
	});
  }

  function syncDisabledState() {
    const disabled = allCheckbox && allCheckbox.checked;
    select.disabled = disabled;
    if (searchInput) searchInput.disabled = disabled;
  }

  if (searchInput) {
    searchInput.addEventListener('input', function () {
      renderOptions(this.value);
    });
  }

  if (allCheckbox) {
    allCheckbox.addEventListener('change', function () {
      syncDisabledState();
    });
  }

  renderOptions('');
  syncDisabledState();
})();
</script>
{% endblock %}
