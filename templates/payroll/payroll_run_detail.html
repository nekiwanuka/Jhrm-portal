{% extends 'base.html' %}
{% block page_title %}Payroll Run {{ run.month|date:"Y-m" }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <a class="btn btn-outline-secondary" href="{% url 'payroll:list' %}">Back</a>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'payroll:export_cleared_csv' run.pk %}">Export Cleared CSV</a>
    <a class="btn btn-outline-secondary" href="{% url 'payroll:penalties' %}">Penalties</a>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div class="table-responsive">
    <table class="table table-sm table-hover align-middle">
      <thead>
        <tr>
          <th>Employee</th>
          <th class="text-end">Gross</th>
          <th class="text-end">Deductions</th>
          <th class="text-end">Penalties</th>
          <th class="text-end">Tax</th>
          <th class="text-end">Net</th>
          <th>Voucher</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for ps in payslips %}
          <tr>
            <td>{{ ps.employee.get_full_name|default:ps.employee.username }}</td>
            <td class="text-end">{{ ps.gross_pay }}</td>
            <td class="text-end">{{ ps.deduction_total }}</td>
            <td class="text-end">{{ ps.penalty_total }}</td>
            <td class="text-end">{{ ps.tax_amount }}</td>
            <td class="text-end fw-semibold">{{ ps.net_pay }}</td>
            <td>
              {% if ps.salary_voucher %}
                <span class="badge {% if ps.salary_voucher.status == 'CLEARED' %}text-bg-success{% else %}text-bg-warning{% endif %}">
                  {{ ps.salary_voucher.get_status_display }}
                </span>
                <div class="small text-muted">{{ ps.salary_voucher.voucher_number }}</div>
              {% else %}
                <span class="text-muted">â€”</span>
              {% endif %}
            </td>
            <td class="text-end">
              {% if ps.salary_voucher and ps.salary_voucher.status != 'CLEARED' %}
                <form method="post" action="{% url 'payroll:clear_voucher' ps.pk %}" class="d-inline">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-success" type="submit">Clear Voucher</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8">No payslips generated.</td></tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </div>
</div>
{% endblock %}
